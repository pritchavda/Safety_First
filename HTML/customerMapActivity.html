<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wecome Page</title>
    <link rel="stylesheet" href="../css/index.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.5.0/mdb.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/customermapm.css" />
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.5.0/mdb.min.js"
    ></script>

    <script
      src="https://js.api.here.com/v3/3.1/mapsjs-core.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
    <script
      src="https://js.api.here.com/v3/3.1/mapsjs-service.js"
      type="text/javascript"
      charset="utf-8"
    ></script>

    <!-- new added -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""
    />
    <link rel="stylesheet" href="../css/style.css" />
    <!-- <script src="../js/app.js"></script> -->
    <style>
      /* body{
            margin: 0;
            padding: 0;
        }
        #map{
            position: relative;
            width: 100%;
            height: 100vh;
        }
        .divlogout{
            position: absolute;
            top: 10px;
            left: 10px;
        } */
      .namee {
        position: absolute;
        top: 200px;
      }
      .divlogout {
        position: absolute;
        z-index: 999;
        top: 20px;
        right: 20px;
      }
    </style>
    <link rel="stylesheet" href="../css/style2.css" />
    <!-- <link rel="stylesheet" href="../Book1.json"> -->
  </head>
  <body style="overflow: hidden">
    <div class="navbar" style="background-color: transparent !important;
    position: absolute;
    z-index: 1000;
    ">
      <div class="navcont2"style="background-color: transparent !important;">
        <div class="navlogo2">
          <img src="../img/parivahan logo1.png" style="width: 100px; margin-bottom: 10px; margin-left: 10px; margin-top: 10px;"  alt="" />
        </div>
        <div class="nav">
          <ul class="navul">
            <li class="navli"  style="display: none;">
              <a href="AboutUs.html" class="nava" >About Us</a>
            </li>
            <li class="navli"  style="display: none;">
              <a href="ContectUs.html" class="nava">Contact Us</a>
            </li>
            <li class="navli"  style="display: none;">
              <a href="p-flit.html" class="nava">P-fleet</a>
            </li>
            <button
              id="userInfoBtn"
              class="gotoconsole navbtn"
              style="display: none"
            >
              UserInfo
            </button>
            <button id="logOut" style="background: white;" class="gotoconsole navbtn">Logout</button>
            <button id="history" class="gotoconsole navbtn"  style="display: none; background: white;">
              <a href="History.html" style="color: #fec842; margin-bottom: 20px"
                >History</a
              >
            </button>
            <button id="setting" class="gotoconsole navbtn" style="background: white;">Setting</button>
          </ul>
        </div>
      </div>
    </div>
    <div id="map" ></div>
    <div class="formBlock" style="display: none;">
      <form id="form">
        <input
          type="text"
          name="start"
          class="input"
          id="start"
          placeholder="Choose starting point"
          required
        />
        <input
          type="text"
          name="end"
          class="input"
          id="destination"
          placeholder="Choose starting point"
          required
        />
        <div>
          <label for="UberX"></label>
          <input
            type="radio"
            id="UberX"
            class="radio"
            name="selectCar"
            value="UberX"
            checked
          />UberX
          <label for="UberBlack"></label>
          <input
            type="radio"
            id="UberBlack"
            class="radio"
            name="selectCar"
            value="UberBlack"
          />UberBlack
          <label for="UberXl"></label>
          <input
            type="radio"
            id="UberXl"
            class="radio"
            name="selectCar"
            value="UberXl"
          />UberXl
        </div>
        <button id="directionnn" class="radio Mapbtn" type="submit">
          Get Directions
        </button>
        <button id="callUber" class="Mapbtn">Call Uber</button>
      </form>

      <button id="cancelUber" class="Mapbtn" style="display: none">
        Cancel Uber
      </button>
    </div>

    <div id="userInfof">
      <div id="userInfo">
        <img
          id="DriverImg"
          style="
            width: 125px;
            height: 125px;
            border-radius: 50%;
            padding: 10px;
            border: 2px solid #fec842;
          "
          src=""
          height="96px"
          width="96px"
          alt=""
        />
        <p id="DriverName" class="formclassinput"></p>
        <p id="DriverPhone" class="formclassinput"></p>
        <p id="DriverCar" class="formclassinput"></p>
      </div>
    </div>

    <div class="divlogout"></div>
    <div id="settingf">
      <form method="post" class="settingform">
        <!-- <label for="userImg">
                <img src="../img/blue.png" alt="" width="100" height="100" style="cursor: pointer;">
            </label> -->
        <!-- <img src="../img/blue.png" id="userImg" alt="" width="100" height="100" style="height: 50px; width: 50px; cursor: pointer; border: 2px solid black;"> -->
        <!-- <input type="image" id="userImg" style="display: none;"> -->
        <label for="userImg2">
          <img
            style="
              width: 125px;
              height: 125px;
              border-radius: 50%;
              padding: 10px;
              border: 2px solid #fec842;
            "
            src="../img/blue.png"
            id="userImgL"
            style="border: 2px solid black"
            width="100"
            height="100"
          />
        </label>
        <input
          type="file"
          id="userImg2"
          placeholder="UserImg"
          style="display: none"
        />
        <input
          type="text"
          id="userName"
          class="formclassinput"
          placeholder="Name"
        />
        <input
          type="tel"
          id="userPhone"
          class="formclassinput"
          placeholder="Phone"
          maxlength="10"
          minlength="10"
        />
        <label for="userShare">You Can Shar With Other:</label>
        <input
          type="checkbox"
          class="formclassinput"
          id="userShare"
          name="userSharename"
          onclick="usersharfuctnion()"
        />
        <input
          type="number"
          id="person"
          class="formclassinput"
          name="personname"
          min="1"
          max="8"
          style="display: none"
        />
        <!-- <input type="text" placeholder="Name"> -->
        <button id="submit" class="submitcustoinfo">Submit</button>
      </form>
    </div>
  </body>
  <script
    src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""
  ></script>
  <script src="../js/jquery-latest.min.js"></script>
  <script>
    function usersharfuctnion() {
      var userShare = document.getElementById("userShare");
      var person = document.getElementById("person");
      if (userShare.checked == true) {
        // alert('chackbox is chacked');
        person.style.display = "inline";
      }
      if (userShare.checked == false) {
        // alert('chackbox is chacked');
        person.style.display = "none";
      }
    }
  </script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.5/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.5/firebase-analytics.js";
    import {
      getDatabase,
      set,
      ref,
      update,
      get,
      child,
      onValue,
      push,
      remove,
    } from "https://www.gstatic.com/firebasejs/9.6.5/firebase-database.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/9.6.5/firebase-auth.js";
    import {
      getStorage,
      ref as sRef,
      uploadBytesResumable,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/9.6.5/firebase-storage.js";
    import Geohash from "https://cdn.jsdelivr.net/gh/chrisveness/latlon-geohash/latlon-geohash.js";
    // import {kill} from "../Book1.json";

    // import { createRequire } from 'module'; // <------ trick to get a require function
    // const require = createRequire(import.meta.url);

    // Initialize Firebase
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyDzU2LsVytDkMXwCidTmO-E4-Xbg62Mdb0",
      authDomain: "parivahan-f7413.firebaseapp.com",
      databaseURL: "https://parivahan-f7413-default-rtdb.firebaseio.com",
      projectId: "parivahan-f7413",
      storageBucket: "parivahan-f7413.appspot.com",
      messagingSenderId: "127872997898",
      appId: "1:127872997898:web:1910d19b13d17210fb9df3",
      measurementId: "G-7VFN151RC8",
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth();
    const database = getDatabase(app);
    const dbRef = ref(getDatabase());
    var files = [];
    var reader = new FileReader();
    const seturl = "";
    let killdeta;
    var progress;
    var destination;
    var destinationLat;
    var destinaionLng;
    var person;
    var newlocation;
    var setconst;
    function GetFileName(file) {
      var temp = file.name.split(".");
      var fname = temp.slice(0, -1).join(".");
      return fname;
    }
    function GetFileExt(file) {
      var temp = file.name.split(".");
      var ext = temp.slice(temp.length - 1, temp.length);
      return "." + ext[0];
    }
    userImgL.addEventListener("click", (event) => {});

    // console.log(kill);

    // fetch('../Book1.json').then((response) => response.json()).then((json) => killdeta =json );
    fetch("../Book1.json")
      .then((response) => response.json())
      .then(async (json) => {
        console.log(json);
        
        await json.map( (item) => {
          console.log(item.amp);
            let colour_num =Math.floor((Math.random() * 3) + 1);
          setDestinationMarker(item.amp,item.lon,colour_num);
        });
      });

    // killdeta.forEach(element => {
    //     console.log(element.amp);
    // });

    // for (let i = 0; i < 4; i++) {
    //     const element = killdeta[i];

    //     console.log(element.amp);

    // }
    // console.log(killdeta.length);
    // direction.addEventListener('click',(event)=>{
    //     console.log("click on direction");
    //     event.preventDefault()
    //     var des = document.getElementById('destination');
    //     destination = des.value;

    //     var theUrl = "https://geocoder.ls.hereapi.com/6.2/geocode.json?serchtext=Ahmedabad&gen=9&apiKey={XfKXDR6KHy8LbW_Yn9lhauo-aH2uaka3F9uE-7lViXw}"
    //     var xmlHttp = new XMLHttpRequest();
    //     xmlHttp.open("GET",theUrl,false);
    //     xmlHttp.send(null);
    //     console.log("ddddddddddddddddddddddddddddd");
    //     var json = JSON.parse(xmlHttp.responseText)
    //     console.log("direction = ",json);
    // })
    userImg2.onchange = (e) => {
      files = e.target.files;
      var extention = GetFileExt(files[0]);
      var name = GetFileName(files[0]);

      console.log(name);
      console.log("ext =", extention);

      reader.readAsDataURL(files[0]);
    };
    reader.onload = function () {
      userImgL.src = reader.result;
    };
    //--------------------- UploadImg ------------------------------//

    // async function UploadProcess(){
    //     var ImgToUpload = files[0];
    //     console.log(files[0]);
    //     // var ImgName = namebox.value +
    //     const metaData = {
    //         contentType: ImgToUpload.type
    //     }
    //     var iimgname = GetFileName(files[0]);
    //     var extName = GetFileExt(files[0]);
    //     var ImageName = iimgname + extName;
    //     const storage = getStorage;
    //     const storageref = sRef(storage,"profile_Image/"+ImageName);

    //     const UploadTask = uploadBytesResumable(mountainsRef,ImgToUpload,metaData);

    //     UploadTask.on('state-changed',(snapshot)=>{
    //         var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
    //         console.log(progress+ '%');
    //     },(error)=>{
    //         alert("error:image not uploded! successfuly")
    //     },()=>{
    //         getDownloadURL(UploadTask.snapshot.ref).then((downlodUrl)=>{
    //             console.log(downlodUrl);
    //         })
    //     })
    // }

    //   ------------------------------------- Uplod Img new ------------------------//
    async function UploadProcess(userName, userPhone, person) {
      var ImgToUpload = files[0];
      // var ImgName = namebox.value +
      const metaData = {
        // contentType: ImgToUpload.type
        contentType: "image/jpeg",
      };
      // var iimgname = GetFileName(files[0]);
      // var extName = GetFileExt(files[0]);
      // var ImageName = iimgname + extName;
      // const storage = getStorage;
      const storage = getStorage();
      // const storageref = ref(storage,"profile_Image/"+ImageName);
      const user = auth.currentUser;
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const mountainsRef = sRef(storage, "profile_Image/" + user.uid);
          const UploadTask = uploadBytesResumable(
            mountainsRef,
            ImgToUpload,
            metaData
          );

          UploadTask.on(
            "state-changed",
            (snapshot) => {
              progress =
                (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              console.log(progress + "%");
            },
            (error) => {
              alert("error:image not uploded! successfuly");
            },
            () => {
              if (files[0]) {
                console.log(files[0]);
                console.log("file is avelable");
                getDownloadURL(UploadTask.snapshot.ref).then((downlodUrl) => {
                  console.log(downlodUrl);
                  // console.log("log prosess"+ progress);
                  if (user) {
                    alert(person);
                    custoemrUid(user.uid);
                    update(ref(database, "Users/" + "Customers/" + user.uid), {
                      email: user.email,
                      name: userName,
                      phone: userPhone,
                      profileImageUrl: downlodUrl,
                      person: person,
                    });
                    // set(ref(database, 'Users/'+'Customers/'+ user.uid+"/"+"google"),{
                    //     name: "llb",
                    //     profileImageUrl: downlodUrl
                    // })
                  }
                });
              }
            }
          );
        }
      });
    }
    // ------------------------------Not uplod img ---------------------------------//

    // ------------------------set destinaion ----------------------------//
    // function setDestinationLatLng(lat,lng) {
    //     console.log(lat,lng);
    //     if (driverFoundId) {

    //     }
    //     update(ref(database, 'Users/'+'Drivers/'+ driverFoundId + "/"+"customerRequest/"),{
    //             customerRideId : muser.uid,
    //             destination: destination
    //     })

    // }
    function runDirection(Directionloction) {
      var platform = new H.service.Platform({
        apikey: "y_ZOv5v2wT9JxHHVNUB9u1vWxqs_GTTrihu5QpiYFUI",
      });

      var service = platform.getSearchService();
      //set massage
      service.geocode(
        {
          q: Directionloction,
        },
        (result) => {
          // Add a marker for each location found
          result.items.forEach((item) => {
            console.log("this is work");
            console.log("pos: ", item.position);
            destinationLat = item.position.lat;
            destinaionLng = item.position.lng;
            setDestinationMarker(destinationLat, destinaionLng,'');
            // setDestinationLatLng(item.position.lat,item.position.lng);
          });
        },
        alert
      );
    }
    function setDestinationMarker(deslat, deslng, colourr) {
      // function setDestinationMarker(39.3679000000, '-76.5555900000') {
      var DesMarker;
      console.log("Data types is :" + typeof deslat);
      if (DesMarker) {
        map.removeLayer(DriverMarker);
      }
      let massages;
      if (colourr == 1 ) {
        massages = "<p><b>Low crime rate </b></p> <p>\n<b> Weapon Used : Hand</b></p>"
      }
      else if (colourr == 2 ) {
        massages = "<p><b>Modrate crime rate</b></p> <p>\n<b> Weapon Used : knfie</b></p>"
        }
        else {
          massages = "<p><b>High Alert!! \n</b></p> <p>\n<b> Weapon Used : Firearm</b></p>"
      }
      var Drivercustom_icon;
      console.log(deslat, deslng);
      Drivercustom_icon = L.icon({
        iconUrl: `../img/drop up${colourr}.png`,
        iconSize: [70, 70],
        iconAnchor: [10, 29],
        popupAnchor: [22, -25],
      });
      DesMarker = L.marker([deslat, deslng], {
        icon: Drivercustom_icon,
      }).bindPopup(massages);
      // map = L.map('map').setView([lat,lng], 15);
      var featureGroup = L.featureGroup([DesMarker]).addTo(map);
      map.setView([deslat, deslng], 15);
    }

    directionnn.addEventListener("click", (event) => {
      event.preventDefault();
      destination = document.getElementById("start").value;
      let Directionloction = document.getElementById("start").value;
      runDirection(Directionloction);
      console.log("Hellow");
    });

    // ------------------------End set destinaion ----------------------------//

    async function NotUploadProcess(userName, userPhone, person) {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          var downlod = "";
          console.log("file is not avelable");
          console.log(userName);
          const user = auth.currentUser;
          get(child(dbRef, `Users/Customers/${user.uid}`))
            .then((snapshot) => {
              if (snapshot.exists()) {
                downlod = snapshot.val().profileImageUrl;
                console.log("file url", downlod);

                if (downlod) {
                  custoemrUid(user.uid);
                  // alert(person);
                  update(ref(database, "Users/" + "Customers/" + user.uid), {
                    email: user.email,
                    name: userName,
                    phone: userPhone,
                    profileImageUrl: downlod,
                    person: person,
                  });
                  console.log("This is work");
                  // update(ref(database, 'Users/'+'Customers/'+ user.uid+"/"),{
                  //     email:'email@gmail.com',
                  //     pagli:"pagli"
                  // })
                }
              } else {
              }
            })
            .catch((error) => {
              console.error(error);
            });
          console.log(downlod);
        }
      });
    }

    // userImg.onclick = UploadProcess;
    logOut.addEventListener("click", (event) => {
      signOut(auth)
        .then(() => {
          // Sign-out successful.
          location.replace("index.html");
        })
        .catch((error) => {
          // An error happened.
          const errorCode = error.code;
          const errorMessage = error.message;
          alert(errorMessage);
        });
    });
    // history.addEventListener("click",(event)=>{
    //     console.log("hi");
    // })
    $(document).ready(function () {
      $("#setting").click(function () {
        $("#settingf").toggle();
      });
    });
    // $(document).ready(function() {
    //     $("#history").click(function() {
    //         $("#historycont").toggle();
    //     });
    // });
    $(document).ready(function () {
      $("#userInfoBtn").click(function () {
        $("#userInfof").toggle();
      });
    });
    let arrylist = [];
    let Noarrylist = [];
    let driverkey;
    let driverFoundId;
    let driverFoundFinal = [];
    let CountdriverIsnot = 0;
    let cont = 0;
    function setUserlocation(postion) {
      newlocation = postion.coords;
      var lat = postion.coords.latitude;
      var lng = postion.coords.longitude;
      callUber.addEventListener("click", (event) => {
        console.log("click");
        if (destination) {
          const userrr = auth.currentUser;
          if (userrr !== null) {
            const uiddd = userrr.uid;
            console.log(uiddd);
            const geohash = Geohash.encode(lat, lng, 10);
            console.log(geohash);
            // set(ref(database, 'DriverAvailable/'+ uiddd),{
            // })
            set(ref(database, "CustomerRequest/" + uiddd + "/"), {
              g: geohash,
              l: [lat, lng],
            });
          }

          get(child(dbRef, `DriverAvailable`))
            .then((snapshot) => {
              if (snapshot.exists()) {
                // console.log(snapshot.val());
                // console.log(snapshot.val())
                var i = snapshot.val();
                console.log(i);
                var count = 0;
                for (let key in i) {
                  // count = count+1;
                  // // arrylist.push([key,i[key]])
                  // console.log("this is work"+[key]);

                  // let servicess = "UberX";
                  //     get(child(dbRef, `Users/Drivers/${key}`)).then((snapshot) => {
                  //         console.log("after key"+key);
                  //         if (snapshot.exists()) {
                  //             console.log(snapshot.val());
                  //             if (snapshot.val().service == servicess) {
                  //             console.log("nnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn" +snapshot.val().service);
                  //             alert(key + '   Uber x');
                  //                 console.log("tttttttttttttttttttrrrrrrrrrrrrrrrrruuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuueeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee");
                  //                 arrylist.push(key);
                  //             }
                  //             if (snapshot.val().service != servicess){
                  //                 alert('Not Uber x');
                  //                 console.log("nnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn" +snapshot.val().service);
                  //                 console.log("nnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn");
                  //                 Noarrylist.push(key);
                  //             }
                  //         }
                  //     });

                  arrylist.push(key);
                }
                console.log(count);
                // console.log( "This is arry list"+arrylist[0]);
                // console.log( "This is Noarry list"+Noarrylist[0]);
                // console.log(arrylist);
                // console.log(arrylist[0]);
                driverkey = arrylist[0];
                var ele = document.getElementsByName("selectCar");
                for (var i = 0; i < ele.length; i++) {
                  if (ele[i].checked)
                    // document.getElementById("result").innerHTML
                    // 		= "Gender: "+ele[i].value;
                    var servicee = ele[i].value;
                  if (servicee) {
                    console.log(servicee);
                  }
                }
                // console.log("aaaaaaaaaaaaaaaaaaaaryyyyyyyyyyyyyyyyy" + driverkey);
                for (let index = 0; index < arrylist.length; index++) {
                  const element = arrylist[index];
                  console.log("for index" + element);
                  let servicess = servicee;
                  get(child(dbRef, `Users/Drivers/${element}`))
                    .then((snapshot) => {
                      console.log("after key" + element);
                      if (snapshot.exists()) {
                        if (snapshot.val().service == servicess) {
                          if (cont == 0) {
                            get(child(dbRef, `Users/Drivers/${element}/`)).then(
                              (snapshot) => {
                                if (snapshot.exists()) {
                                  var personame = parseInt(person);
                                  if (personame) {
                                    if (snapshot.val().totalP) {
                                      var totalpint = parseInt(
                                        snapshot.val().totalP
                                      );
                                      var psum = personame + totalpint;
                                      alert(typeof personame);
                                      // alert(typeof totalpint)
                                      alert(
                                        `${personame}+${totalpint}=${psum}`
                                      );
                                      var personpint = parseInt(
                                        snapshot.val().person
                                      );
                                      if (psum <= personpint) {
                                        chackGoto(element);
                                      }
                                      // else{
                                      //     // setimeoutduretion();
                                      // }
                                    } else {
                                      var personnpint = parseInt(
                                        snapshot.val().person
                                      );
                                      if (personame <= personnpint) {
                                        chackGoto(element);
                                      }
                                      // else{
                                      //     // setimeoutduretion();
                                      // }
                                    }
                                  } else {
                                    chackGoto(element);
                                  }
                                }
                              }
                            );
                          }
                        } else {
                          setimeoutduretion();
                        }
                      }
                    })
                    .then(() => {
                      console.log();
                    });
                }
                // driverFoundId = driverFoundFinal[0];
                // driverFoundId = arrylist[0];

                console.log("driver found id is" + driverFoundFinal[0]);
                // arrylist.forEach(driverFoundKey);

                // getDriverLocation();

                // const db = getDatabase();
                // const starCountRef = ref(db,`DriverAvailable/${driverkey}/I/0`);
                // onValue(starCountRef, (snapshot) => {
                //     const data = snapshot.val();
                //     console.log("on data value is");
                //     console.log(data);
                //     updateStarCount(postElement, data);
                // });
              } else {
                console.log("No data available");
              }
            })
            .catch((error) => {
              console.error(error);
            });
          // const driverlocation = [];
          //     get(child(dbRef, `DriverAvailable/${driverkey}/I/0`)).then((snapshot) => {
          //         if (snapshot.exists()) {
          //             // const driverloc = ;
          //             // var driverlatitude = snapshot.val();
          //             // driverlocation.push(driverlatitude);
          //             console.log("let:"+snapshot.val());
          //         }
          //         else {
          //             console.log("No data available");
          //         }
          //         }).catch((error) => {
          //         console.error(error);
          //     });
          // var moth = false;
          //     get(child(dbRef, `DriverAvailable/${driverkey}/I/1`)).then((snapshot) => {
          //         if (snapshot.exists()) {
          //             // const driverloc = ;
          //             // driverlongitude = snapshot.val();
          //         }
          //         else {
          //             console.log("No data available");
          //         }
          //         }).catch((error) => {
          //         console.error(error);
          //         moth = true;
          //     });
          //     if (moth = true) {
          //         console.log(driverlocation[0]);
          //         // console.log(driverlongitude);
          //     }
        } else {
          alert("set Direction");
        }
      });
    }
    function chackGoto(element) {
      get(child(dbRef, `Users/Drivers/${element}/Goto`)).then((snapshot) => {
        if (snapshot.exists()) {
          var startt = document.getElementById("start").value;
          var destinattion = document.getElementById("destination").value;
          // alert(startt +' '+snapshot.val().Start);
          if (
            startt == snapshot.val().Start &&
            destinattion == snapshot.val().Stop
          ) {
            driverFoundFinal.push(element);
            cont++;
            // alert("servicess is " + element + snapshot.val().servicess)
            getddd();
            getDriverLocation();
            setcustomerRequest();
          } else {
            setimeoutduretion();
          }
        } else {
          driverFoundFinal.push(element);
          cont++;
          // alert("servicess is " + element + snapshot.val().servicess)
          getddd();
          getDriverLocation();
          setcustomerRequest();
        }
      });
    }
    // let dsarry =[];
    // function driverFoundKey(key,index) {
    //     console.log(key+":"+index);
    //     // let servicess = "UberBlack";
    //     // get(child(dbRef, `Users/Drivers/${key}`)).then((snapshot) => {
    //     //     if (snapshot.exists()) {
    //     //         console.log(snapshot.val());
    //     //         console.log("nnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn" +snapshot.val().service);
    //     //         if (snapshot.val().service == servicess) {
    //     //             dsarry.push(key);
    //     //         }
    //     //     }
    //     // });
    //     // DriveravorNot();
    // }
    // function DriveravorNot() {
    //     if (dsarry[0]) {
    //         driverFoundId = dsarry[0];
    //         getDriverLocation();
    //     }
    //     else{
    //         alert('Driver Not Avelable');
    //     }
    // }

    var delayInMilliseconds = 1000 * 10; //1 second
    function setimeoutduretion() {
      setTimeout(function () {
        if (!driverFoundFinal[0]) {
          if (CountdriverIsnot == 0) {
            console.log("this is delay");
            alert("driver is not Found");
            CountdriverIsnot++;
          }
        }
      }, delayInMilliseconds);
    }

    function multipelcustomerRequest(driverId) {
      var customerusid = auth.currentUser;
      alert(driverId + customerusid.uid);

      const dbb = getDatabase();

      // A post entry.
      const postData = {
        customerRideId: customerusid.uid,
        destination: destination,
        destinaionLng: destinaionLng,
        destinationLat: destinationLat,
        pickuplat: newlocation.latitude,
        pikuplng: newlocation.longitude,
      };

      // Get a key for a new Post.
      const newPostKey = push(child(ref(dbb), "multipelCustomerRequest")).key;

      // Write the new post's data simultaneously in the posts list and the user's post list.
      const updates = {};
      updates[
        "Users/" +
          "Drivers/" +
          driverFoundFinal[0] +
          "/" +
          "customerRequest/" +
          "sharCustomer/" +
          newPostKey
      ] = true;
      updates["/multipelCustomerRequest/" + newPostKey] = postData;
      return update(ref(dbb), updates);
    }
    function setcustomerRequest() {
      const muser = auth.currentUser;
      if (destination) {
        get(
          child(
            dbRef,
            "Users/" +
              "Drivers/" +
              driverFoundFinal[0] +
              "/" +
              "customerRequest/"
          )
        ).then((snapshot) => {
          if (snapshot.exists()) {
            if (!setconst) {
              multipelcustomerRequest(driverFoundFinal[0]);
              var user22 = auth.currentUser;
              update(ref(database, "Users/" + "Customers/" + user22.uid), {
                personval: "true",
              });
              alert("person val true");
              getDriverInfo(driverFoundFinal[0]);
              setconst = "true";
            }
          } else {
            update(
              ref(
                database,
                "Users/" +
                  "Drivers/" +
                  driverFoundFinal[0] +
                  "/" +
                  "customerRequest/"
              ),
              {
                customerRideId: muser.uid,
                destination: destination,
                destinaionLng: destinaionLng,
                destinationLat: destinationLat,
                pickuplat: newlocation.latitude,
                pikuplng: newlocation.longitude,
              }
            );
            getDriverInfo(driverFoundFinal[0]);
          }
        });
      } else {
        update(
          ref(
            database,
            "Users/" +
              "Drivers/" +
              driverFoundFinal[0] +
              "/" +
              "customerRequest/"
          ),
          {
            customerRideId: muser.uid,
          }
        );
      }
    }
    function getddd() {
      console.log("ididididididididi" + driverFoundFinal[0]);
    }
    function getDriverLocation() {
      let latdata;
      const db = getDatabase();
      const Drif = ref(db, `DriverAvailable/${driverFoundFinal[0]}/l/`);
      onValue(Drif, (snapshot) => {
        const nn = snapshot.val();
        console.log("lat,lng is", nn[0]);
        MarkDriverLocation(nn[0], nn[1]);
        // updateStarCount(postElement, data);
      });
      console.log("hi hi hi");
      // console.log(driverFoundFinal[0]);
    }

    function MarkDriverLocation(driverlat, driverlng) {
      console.log(driverlat, driverlng);
      var DriverMarker;
      if (DriverMarker) {
        map.removeLayer(DriverMarker);
      }
      var Drivercustom_icon;
      callUber.setText = "Driver Found";
      console.log(driverlat, driverlng);
      Drivercustom_icon = L.icon({
        iconUrl: "../img/cariamge.png",
        iconSize: [20, 29],
        iconAnchor: [10, 29],
        popupAnchor: [0, -29],
      });
      DriverMarker = L.marker([driverlat, driverlng], {
        icon: Drivercustom_icon,
      }).bindPopup("<p><b>DriverLocaiton<b></p>");
      // map = L.map('map').setView([lat,lng], 15);
      var featureGroup = L.featureGroup([DriverMarker]).addTo(map);
      map.setView([driverlat, driverlng], 15);
    }
    const user = auth.currentUser;
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in, see docs for a list of available properties
        // https://firebase.google.com/docs/reference/js/firebase.User
        // location.replace("welcome.html");

        // document.getElementById('setemail').innerHTML = 'Hellow, ' + user.email;
        custoemrUid(user.uid);
        localStorage.setItem("userId", user.uid);
        get(child(dbRef, `Users/Customers/${user.uid}`))
          .then((snapshot) => {
            if (snapshot.exists()) {
              console.log(snapshot.val());
              const db = getDatabase();

              // A post entry.
              const postData = {
                email: user.email,
              };

              // Get a key for a new Post.
              const newPostKey = push(
                child(ref(db), "Users/" + "Customers/" + user.uid)
              ).key;

              // Write the new post's data simultaneously in the posts list and the user's post list.
              const updates = {};
              // updates['/posts/' + newPostKey] = postData;
              updates["Users/" + "Customers/" + user.uid] = postData;
            } else {
              set(ref(database, "Users/" + "Customers/" + user.uid), {
                email: user.email,
              });
            }
          })
          .catch((error) => {
            console.error(error);
          });

        get(child(dbRef, `Users/Customers/${user.uid}`))
          .then((snapshot) => {
            if (snapshot.exists()) {
              console.log(snapshot.val());
              setUserInformain(
                snapshot.val().name,
                snapshot.val().phone,
                snapshot.val().profileImageUrl
              );
            } else {
            }
          })
          .catch((error) => {
            console.error(error);
          });
        get(child(dbRef, `Users/Customers/${user.uid}/history`))
          .then((snapshot) => {
            if (snapshot.exists()) {
              console.log(snapshot.val());
              sethistory(snapshot.val());
            } else {
            }
          })
          .catch((error) => {
            console.error(error);
          });
      } else {
        // User is signed out
        // ...
        location.replace("driverLongin.html");
      }
    });

    function sethistory(history) {
      console.log("in isde" + history);
      var arrr = Object.keys(history);
      console.log(Object.entries(history));
      // arrr.forEach(element => {
      //     document.getElementById('historycont').innerHTML= element;
      // });
      // document.getElementById('historycont').innerHTML=arrr + "<br><hr>";
      let arr = [history];
      console.log(arr);
    }
    function singleHistory() {
      alert("the key is");
    }

    function setUserInformain(name, phone, imgsrc) {
      if (imgsrc) {
        console.log(imgsrc);
        userImgL.src = imgsrc;
      } else {
        console.log("img is not set");
      }
      if (name) {
        console.log("name", name);
        userName.value = name;
      } else {
        console.log("Name is not avelable");
      }
      if (phone) {
        console.log("phone", phone);
        userPhone.value = phone;
      } else {
        console.log("Phone is not avelable");
      }
    }
    let custoemrUidd = "";
    function custoemrUid(Uid) {
      console.log(Uid);
      custoemrUidd = Uid;
    }
    console.log("custoemr", custoemrUidd);
    var map = L.map("map").setView([51.505, -0.09], 13);
    var osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }
    );
    osm.addTo(map);

    if (!navigator.geolocation) {
      console.log("your Brouser Doesn`t support geolocaion feature!");
    } else {
      // setInterval(() => {
      // navigator.geolocation.getCurrentPosition(getpostion);
      navigator.geolocation.watchPosition(getpostion);
      navigator.geolocation.watchPosition(setUserlocation);
      // }, 5000);
    }
    var marker;
    var circle;
    function getpostion(postion) {
      var lat = postion.coords.latitude;
      var lng = postion.coords.longitude;
      // console.log(postion);
      var accuracy = postion.coords.accuracy;
      if (marker) {
        map.removeLayer(marker);
      }
      if (circle) {
        map.removeLayer(circle);
      }
      var custom_icon;
      custom_icon = L.icon({
        iconUrl: "../img/customerlocation.png",
        iconSize: [40, 40],
        iconAnchor: [10, 29],
        popupAnchor: [10, -30],
      });
      marker = L.marker([lat, lng], { icon: custom_icon }).bindPopup(
        "<p><b>Your Locaion<b></p>"
      );
      circle = L.circle([lat, lng], { radius: accuracy });
      // map = L.map('map').setView([lat,lng], 15);
      var featureGroup = L.featureGroup([marker, circle]).addTo(map);
      map.setView([lat, lng], 15);
      // map.setZoom([15],animate= true)
      // map.fitBounds(featureGroup.getBounds());
      // console.log("your information is : lat="+ lat+" lng="+lng+" accuracy="+accuracy);

      // const userrr = auth.currentUser;
      // if (userrr !== null) {
      //     const uiddd = userrr.uid;
      //     // console.log(uiddd);
      //     set(ref(database, 'DriverAvailable/'+ uiddd+'/'),{
      //         l:[lat,lng]
      //     })
      // }
      submit.addEventListener("click", (event) => {
        event.preventDefault();
        var userName = document.getElementById("userName").value;

        // console.log("uuuuuuuuuuuuuuuusssssssssssssssrrrrrrrrrrrrrrnnnnnnnn"+userName);
        if (userName) {
        }
        var userPhone = document.getElementById("userPhone").value;
        if (userPhone) {
          console.log(userPhone);
        }
        // var userShare = document.getElementById('userShare');
        person = document.getElementById("person").value;
        // var person = 2;
        if (userShare.checked == true) {
        }
        if (person) {
        }
        if (files[0]) {
          UploadProcess(userName, userPhone, person);
        } else {
          NotUploadProcess(userName, userPhone, person);
        }
        // console.log( "hi",userName,userPhone);
      });
    }

    //--------------------------------  getCusomerInforMation -------------------------------//
    function getDriverInfo(driverId) {
      get(child(dbRef, `Users/Drivers/${driverId}`))
        .then((snapshot) => {
          if (snapshot.exists()) {
            document.getElementById("userInfoBtn").style.display = "inline";
            document.getElementById("callUber").style.display = "none";
            document.getElementById("cancelUber").style.display = "inline";
            console.log("val  " + snapshot.val());
            setCustomerInfo(
              snapshot.val().name,
              snapshot.val().phone,
              snapshot.val().profileImageUrl,
              snapshot.val().car
            );
          } else {
          }
        })
        .catch((error) => {
          console.error(error);
        });
    }

    function setCustomerInfo(Name, Phone, ImgUrl, Car) {
      console.log("img url is", ImgUrl);
      if (ImgUrl) {
        document.getElementById("DriverImg").src = ImgUrl;
      } else {
        console.log("Img is not set");
      }
      if (Name) {
        document.getElementById("DriverName").innerHTML = Name;
      } else {
        console.log("Name is not define");
      }
      if (Phone) {
        document.getElementById("DriverPhone").innerHTML = Phone;
      } else {
        console.log("Phone is not define");
      }
      if (Car) {
        document.getElementById("DriverCar").innerHTML = Car;
      } else {
        console.log("Car is not define");
      }
    }

    cancelUber.addEventListener("click", () => {
      console.log("cancel uber");
      alert("cancel uber");
      remove(
        ref(
          database,
          "Users/" + "Drivers/" + driverFoundFinal[0] + "/" + "customerRequest/"
        )
      )
        .then(() => {
          alert("Uber Canceled");
        })
        .catch((error) => {
          console.log(error);
        });
    });
    //--------------------------------  EndgetCusomerInforMation -------------------------------//
    // let gethistorykey = document.getElementById('bbt');
    // Array.from(gethistorykey).forEach(element => {
    //     element.addEventListener("click",(e)=>{
    //         console.log("click",e);
    //         alert('eeee');
    //     })
    // });
  </script>
  <script src="/js/drivermap.js"></script>
</html>
<script src="../js/goto.js"></script>
<script></script>
